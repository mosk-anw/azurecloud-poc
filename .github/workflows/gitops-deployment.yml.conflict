name: GitOps Infrastructure Deployment

on:
  push:
    branches: [main, staging, develop]
    paths: ["live_terraform_project/**"]
  pull_request:
    branches: [main, staging, develop]
    paths: ["live_terraform_project/**"]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'development'
        type: choice
        options:
        - development
        - staging
        - production
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy
  schedule:
    - cron: '0 6 * * 1-5'  # Run drift detection weekdays at 6 AM UTC

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

env:
  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  TF_VAR_environment: ${{ github.event.inputs.environment || 'development' }}

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Checkov action
      id: checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: live_terraform_project/
        framework: terraform
        output_format: sarif
        output_file_path: reports/results.sarif
        config_file: .checkov.yml
        download_external_modules: true        
    - name: Upload SARIF file
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: reports/results.sarif

  validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Terraform Format Check
      run: terraform fmt -check=true

    - name: Create temporary backend for validation
      run: |
        # Temporarily move all backend files to avoid conflicts
        mkdir -p ../temp_backends
        mv backend-*.tf ../temp_backends/ || true
        
        # Create a minimal backend.tf for validation only
        cat > backend.tf << 'BACKEND_EOF'
        terraform {
          backend "azurerm" {}
        }
        BACKEND_EOF

    - name: Terraform Init
      run: terraform init -backend=false

    - name: Terraform Validate
      run: terraform validate

    - name: Cleanup validation backend
      run: |
        # Remove temporary backend and restore original files
        rm -f backend.tf
        mv ../temp_backends/backend-*.tf . || true
        rmdir ../temp_backends || true

  plan-development:
    name: Plan Development
    runs-on: ubuntu-latest
    needs: validate
<<<<<<< HEAD
    if: github.ref == \'refs/heads/develop\' || (github.event_name == \'pull_request\' && github.base_ref == \'develop\')
=======
    if: github.ref == 'refs/heads/develop' || (github.event_name == 'pull_request' && github.base_ref == 'develop')
>>>>>>> develop
    environment: development
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Setup backend for development
      run: |
        # Remove other backend files to avoid conflicts
        rm -f backend-staging.tf backend-production.tf
        # Copy development backend as the active backend
        mv backend-development.tf backend.tf

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -var-file="../configs/development.tfvars" -out=tfplan-dev

    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-development
        path: live_terraform_project/tfplan-dev

  deploy-development:
    name: Deploy Development
    runs-on: ubuntu-latest
    needs: plan-development
<<<<<<< HEAD
    if: github.ref == \'refs/heads/develop\' && github.event_name == \'push\'
=======
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
>>>>>>> develop
    environment: development
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-development
        path: live_terraform_project/

    - name: Setup backend for development
      run: |
        rm -f backend-staging.tf backend-production.tf
        mv backend-development.tf backend.tf

    - name: Terraform Init
      run: terraform init

    - name: Terraform Apply
      run: terraform apply tfplan-dev

  plan-staging:
    name: Plan Staging
    runs-on: ubuntu-latest
<<<<<<< HEAD
    needs: deploy-development
    if: github.ref == \'refs/heads/develop\' && github.event_name == \'push\'
=======
    needs: validate
    if: github.ref == \'refs/heads/staging\' && github.event_name == \'push\'
>>>>>>> develop
    environment: staging
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Setup backend for staging
      run: |
        rm -f backend-development.tf backend-production.tf
        mv backend-staging.tf backend.tf

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -var-file="../configs/staging.tfvars" -out=tfplan-staging

    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-staging
        path: live_terraform_project/tfplan-staging

  deploy-staging:
    name: Deploy Staging
    runs-on: ubuntu-latest
    needs: plan-staging
    environment: staging
    if: github.ref == \'refs/heads/staging\' && github.event_name == \'push\'
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-staging
        path: live_terraform_project/

    - name: Setup backend for staging
      run: |
        rm -f backend-development.tf backend-production.tf
        mv backend-staging.tf backend.tf

    - name: Terraform Init
      run: terraform init

    - name: Terraform Apply
      run: terraform apply tfplan-staging

  plan-production:
    name: Plan Production
    runs-on: ubuntu-latest
    needs: deploy-staging
<<<<<<< HEAD
    if: github.ref == \'refs/heads/staging\' && github.event_name == \'push\'
=======
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
>>>>>>> develop
    environment: production
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Setup backend for production
      run: |
        rm -f backend-development.tf backend-staging.tf
        mv backend-production.tf backend.tf

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -var-file="../configs/production.tfvars" -out=tfplan-prod

    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-production
        path: live_terraform_project/tfplan-prod

  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: plan-production
    environment: production
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Download Plan Artifact
      uses: actions/download-artifact@v4
      with:
        name: tfplan-production
        path: live_terraform_project/

    - name: Setup backend for production
      run: |
        rm -f backend-development.tf backend-staging.tf
        mv backend-production.tf backend.tf

    - name: Terraform Init
      run: terraform init

    - name: Terraform Apply
      run: terraform apply tfplan-prod

  drift-detection:
    name: Drift Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    strategy:
      matrix:
        environment: [development, staging, production]
    defaults:
      run:
        working-directory: live_terraform_project
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.9.7

    - name: Setup backend for environment
      run: |
        # Remove other backend files and set up the specific environment
        case "${{ matrix.environment }}" in
          development)
            rm -f backend-staging.tf backend-production.tf
            mv backend-development.tf backend.tf
            ;;
          staging)
            rm -f backend-development.tf backend-production.tf
            mv backend-staging.tf backend.tf
            ;;
          production)
            rm -f backend-development.tf backend-staging.tf
            mv backend-production.tf backend.tf
            ;;
        esac

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan (Drift Check)
      run: |
        terraform plan -var-file="../configs/${{ matrix.environment }}.tfvars" -detailed-exitcode -no-color || {
          if [ $? -eq 2 ]; then
            echo "DRIFT_DETECTED=true" >> $GITHUB_ENV
            echo "Drift detected in ${{ matrix.environment }} environment!"
          fi
        }

    - name: Create Issue for Drift
      if: env.DRIFT_DETECTED == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Infrastructure Drift Detected - ${{ matrix.environment }}`,
            body: `ðŸš¨ **Infrastructure Drift Detected**
            
            **Environment:** ${{ matrix.environment }}
            **Detection Time:** ${new Date().toISOString()}
            
            Please review the infrastructure changes and take appropriate action.
            
            **Next Steps:**
            1. Review the drift details in the workflow logs
            2. Determine if changes are expected
            3. Update Terraform configuration if needed
            4. Re-run deployment to sync infrastructure
            `,
            labels: ['infrastructure', 'drift-detection', '${{ matrix.environment }}']
          })
